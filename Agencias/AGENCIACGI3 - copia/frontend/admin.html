<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrador CGI Autos</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 10px;
        }

        .nav-menu a {
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            color: #1f2937;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #dc2626;
            color: white;
        }

        .btn-primary:hover {
            background: #b91c1c;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            text-transform: uppercase;
            user-select: none;
        }

        th[onclick*="sortAutos"] {
            cursor: pointer;
            transition: all 0.2s ease;
            background: #e5e7eb;
        }

        th[onclick*="sortAutos"]:hover {
            background: #d1d5db;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .img-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #9ca3af;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .image-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: #f9fafb;
        }

        .image-upload:hover {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-preview {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 4px solid #dc2626;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 3000;
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        .section-hidden {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 8px;
        }

        .checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .checkbox input {
            width: auto;
        }

        .checkbox label {
            margin: 0;
            font-weight: 400;
        }

        .section-add-item {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .section-add-item input {
            flex: 1;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .main-content {
                margin-left: 70px;
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>CGI Autos</h2>
                <p>Panel Admin</p>
            </div>
            <ul class="nav-menu">
                <li><a href="#" onclick="showSection('dashboard')" class="nav-link active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#" onclick="showSection('autos')" class="nav-link"><i class="fas fa-car"></i> Mis Autos</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard -->
            <section id="dashboard" class="section-content">
                <div class="header">
                    <h1>Dashboard</h1>
                    <button onclick="sincronizarAutos()" class="btn btn-primary" title="Guardar todos los autos en el servidor">
                        <i class="fas fa-save"></i> Guardar Todo
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number" id="total-autos">0</div>
                        <div class="label">Autos en Catálogo</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="autos-oferta">0</div>
                        <div class="label">En Oferta</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="autos-nuevos">0</div>
                        <div class="label">Autos Nuevos</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="autos-destacados">0</div>
                        <div class="label">Destacados</div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Últimos Autos Agregados</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>Marca / Modelo</th>
                                    <th>Precio</th>
                                    <th>Año</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="recent-autos">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Autos -->
            <section id="autos" class="section-content section-hidden">
                <div class="header">
                    <h1>Gestión de Autos</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="sincronizarAutos()" title="Guardar todos los autos en el servidor">
                            <i class="fas fa-sync-alt"></i> Sincronizar
                        </button>
                        <button class="btn btn-primary" onclick="openNewAutoModal()">
                            <i class="fas fa-plus"></i> Agregar Auto
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th onclick="sortAutos('marca')" style="cursor: pointer;">Marca / Modelo <i class="fas fa-sort"></i></th>
                                <th onclick="sortAutos('version')" style="cursor: pointer;">Versión <i class="fas fa-sort"></i></th>
                                <th onclick="sortAutos('año')" style="cursor: pointer;">Año <i class="fas fa-sort"></i></th>
                                <th onclick="sortAutos('precio')" style="cursor: pointer;">Precio <i class="fas fa-sort"></i></th>
                                <th onclick="sortAutos('kilometraje')" style="cursor: pointer;">KM <i class="fas fa-sort"></i></th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="autos-table">
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal -->
    <div id="autoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Nuevo Auto</h2>
                <button class="close-modal" onclick="closeAutoModal()">&times;</button>
            </div>

            <form id="autoForm" onsubmit="saveAuto(event)">
                <!-- Información Básica -->
                <div class="section">
                    <h3 class="section-title">Información Básica</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="marca">Marca *</label>
                            <input type="text" id="marca" required>
                        </div>
                        <div class="form-group">
                            <label for="modelo">Modelo *</label>
                            <input type="text" id="modelo" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="version">Versión *</label>
                            <input type="text" id="version" required>
                        </div>
                        <div class="form-group">
                            <label for="ano">Año *</label>
                            <input type="number" id="ano" min="1980" max="2099" required>
                        </div>
                    </div>
                </div>

                <!-- Especificaciones Técnicas -->
                <div class="section">
                    <h3 class="section-title">Especificaciones Técnicas</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="motor">Motor</label>
                            <input type="text" id="motor" placeholder="Ej: 1.6L V6">
                        </div>
                        <div class="form-group">
                            <label for="transmision">Transmisión</label>
                            <select id="transmision">
                                <option value="">Selecciona una opción</option>
                                <option value="Manual">Manual</option>
                                <option value="Automática">Automática</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="combustible">Combustible</label>
                            <select id="combustible">
                                <option value="">Selecciona una opción</option>
                                <option value="Gasolina">Gasolina</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Híbrido">Híbrido</option>
                                <option value="Eléctrico">Eléctrico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gnc">¿Tiene GNC?</label>
                            <select id="gnc">
                                <option value="no">No</option>
                                <option value="si">Sí</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Detalles -->
                <div class="section">
                    <h3 class="section-title">Detalles del Vehículo</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="color">Color</label>
                            <input type="text" id="color" placeholder="Ej: Blanco perla">
                        </div>
                        <div class="form-group">
                            <label for="kilometraje">Kilometraje *</label>
                            <input type="number" id="kilometraje" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="precio">Precio *</label>
                            <input type="number" id="precio" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="moneda">Moneda</label>
                            <select id="moneda">
                                <option value="ARS">ARS ($)</option>
                                <option value="USD">USD ($)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Descripción -->
                <div class="section">
                    <h3 class="section-title">Descripción</h3>
                    <div class="form-group form-row full">
                        <textarea id="descripcion" placeholder="Describe el estado general del vehículo..."></textarea>
                    </div>
                </div>

                <!-- Características -->
                <div class="section">
                    <h3 class="section-title">Características</h3>
                    <div class="section-add-item">
                        <input type="text" id="newCaracteristica" placeholder="Agregar característica...">
                        <button type="button" class="btn btn-secondary btn-small" onclick="addCaracteristica()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="item-list" id="caracteristicas-list"></div>
                </div>

                <!-- Imágenes -->
                <div class="section">
                    <h3 class="section-title">Imágenes</h3>
                    <div class="image-upload" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: #dc2626; margin-bottom: 10px;"></i>
                        <p style="margin-bottom: 5px; font-weight: 600;">Arrastra imágenes o haz clic</p>
                        <input type="file" id="fileInput" multiple accept=".png,.jpg,.jpeg,.gif,.webp,.heic,.hec" style="display: none;" onchange="handleFileSelect(event)">
                    </div>
                    <div class="image-preview-container" id="imagePreview"></div>
                </div>

                <!-- Estado -->
                <div class="section">
                    <h3 class="section-title">Estado y Categoría</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="categoria">Categoría</label>
                            <select id="categoria">
                                <option value="suv">SUV</option>
                                <option value="pickup">Pick Up</option>
                                <option value="auto">Auto</option>
                                <option value="utilitario">Utilitario</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="whatsapp">WhatsApp</label>
                            <input type="tel" id="whatsapp" placeholder="54xxxxxxxxx">
                        </div>
                    </div>
                    <div class="checkbox">
                        <input type="checkbox" id="nuevo">
                        <label for="nuevo">Es 0 KM / Nuevo</label>
                    </div>
                    <div class="checkbox">
                        <input type="checkbox" id="destacado">
                        <label for="destacado">Destacar en portada</label>
                    </div>
                    <div class="checkbox">
                        <input type="checkbox" id="oferta">
                        <label for="oferta">En oferta especial</label>
                    </div>
                    <div class="checkbox">
                        <input type="checkbox" id="recienLlegados">
                        <label for="recienLlegados">Recien llegados</label>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 30px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeAutoModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let autos = [];
        let currentAutoId = null;
        let selectedImages = [];
        let caracteristicas = [];
        let sortConfig = { field: null, order: 'asc' }; // Configuración de ordenamiento

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            loadAutos();
            loadDashboard();
        });

        // Ordenamiento de autos
        function sortAutos(field) {
            // Si hacemos click en el mismo campo, invertir orden
            if (sortConfig.field === field) {
                sortConfig.order = sortConfig.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.field = field;
                // Por defecto: texto alfabético (asc), números de mayor a menor (desc)
                sortConfig.order = (field === 'año' || field === 'precio' || field === 'kilometraje') ? 'desc' : 'asc';
            }

            const sorted = [...autos].sort((a, b) => {
                let valueA = a[field];
                let valueB = b[field];

                // Convertir a lowercase para comparación de strings
                if (typeof valueA === 'string') {
                    valueA = valueA.toLowerCase();
                    valueB = valueB.toLowerCase();
                }

                // Comparar según el tipo
                let comparison = 0;
                if (valueA < valueB) {
                    comparison = -1;
                } else if (valueA > valueB) {
                    comparison = 1;
                }

                return sortConfig.order === 'asc' ? comparison : -comparison;
            });

            renderAutosTable(sorted);
            updateSortIndicators();
        }

        // Actualizar indicadores visuales de ordenamiento
        function updateSortIndicators() {
            const headers = document.querySelectorAll('thead th[onclick*="sortAutos"]');
            headers.forEach(header => {
                const fieldMatch = header.getAttribute('onclick').match(/sortAutos\('(\w+)'\)/);
                if (!fieldMatch) return;
                
                const field = fieldMatch[1];
                let indicator = '';
                
                if (sortConfig.field === field) {
                    indicator = sortConfig.order === 'asc' ? ' ▲' : ' ▼';
                }
                
                // Actualizar el contenido del header
                const content = header.innerHTML.replace(/ ▲| ▼/g, '');
                header.innerHTML = content + indicator;
            });
        }

        // Cargar autos desde el servidor
        async function loadAutos() {
            try {
                const response = await fetch('/api/autos');
                if (response.ok) {
                    const data = await response.json();
                    // La API devuelve autos_ejemplo array
                    autos = Array.isArray(data) ? data : (data.autos_ejemplo || []);
                    renderAutosTable(autos);
                } else {
                    showToast('Error al cargar autos del servidor', 'error');
                    autos = [];
                    renderAutosTable(autos);
                }
            } catch (error) {
                console.error('Error cargando autos:', error);
                showToast('Error de conexión al cargar autos', 'error');
                autos = [];
                renderAutosTable(autos);
            }
        }

        function loadDashboard() {
            // Asegurarse de tener datos frescos
            loadAutos().then(() => {
                document.getElementById('total-autos').textContent = autos.length;
                document.getElementById('autos-oferta').textContent = autos.filter(a => a.oferta).length;
                document.getElementById('autos-nuevos').textContent = autos.filter(a => a.nuevo).length;
                document.getElementById('autos-destacados').textContent = autos.filter(a => a.destacado).length;

                const recent = autos.slice(-5).reverse();
                const tbody = document.getElementById('recent-autos');
                tbody.innerHTML = recent.map(auto => {
                    const imgUrl = auto.imagen ? (auto.imagen.startsWith('http') ? auto.imagen : `https://gonzalobergmans.pythonanywhere.com/${auto.imagen}`) : 'placeholder.jpg';
                    return `
                    <tr>
                        <td><img src="${imgUrl}" alt="${auto.marca}" class="img-thumbnail" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2212%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22%3ESin foto%3C/text%3E%3C/svg%3E'"></td>
                        <td><strong>${auto.marca}</strong><br>${auto.modelo}</td>
                        <td>${auto.moneda} ${formatCurrency(auto.precio)}</td>
                        <td>${auto.año}</td>
                        <td>
                            <button class="btn btn-secondary btn-small" onclick="editAuto(${auto.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;}).join('');
            });
        }

        function renderAutosTable(list) {
            const tbody = document.getElementById('autos-table');
            tbody.innerHTML = list.map(auto => {
                const imgUrl = auto.imagen ? (auto.imagen.startsWith('http') ? auto.imagen : `https://gonzalobergmans.pythonanywhere.com/${auto.imagen}`) : 'placeholder.jpg';
                return `
                <tr>
                    <td><img src="${imgUrl}" alt="${auto.marca}" class="img-thumbnail" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3C/svg%3E'"></td>
                    <td><strong>${auto.marca}</strong><br>${auto.modelo}</td>
                    <td>${auto.versión}</td>
                    <td>${auto.año}</td>
                    <td>${auto.moneda} ${formatCurrency(auto.precio)}</td>
                    <td>${auto.kilometraje.toLocaleString('es-AR')}</td>
                    <td style="display: flex; gap: 5px;">
                        <button class="btn btn-secondary btn-small" onclick="editAuto(${auto.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteAuto(${auto.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Actualizar indicadores de ordenamiento
            updateSortIndicators();
        }

        // Secciones
        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.add('section-hidden'));
            document.getElementById(sectionId).classList.remove('section-hidden');
            
            document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
            event.target.closest('a').classList.add('active');

            if (sectionId === 'dashboard') {
                loadDashboard();
            }
        }

        // Modal
        function openNewAutoModal() {
            currentAutoId = null;
            document.getElementById('modal-title').textContent = 'Nuevo Auto';
            document.getElementById('autoForm').reset();
            selectedImages = [];
            caracteristicas = [];
            updateCaracteristicasList();
            updateImagePreview();
            document.getElementById('autoModal').classList.add('active');
        }

        function closeAutoModal() {
            document.getElementById('autoModal').classList.remove('active');
            // Guardar autos cuando se cierra el modal
            sincronizarAutos();
        }

        // Editar
        function editAuto(autoId) {
            const auto = autos.find(a => a.id === autoId);
            if (!auto) return;

            currentAutoId = auto.id;
            document.getElementById('modal-title').textContent = `Editar: ${auto.marca} ${auto.modelo}`;
            
            document.getElementById('marca').value = auto.marca;
            document.getElementById('modelo').value = auto.modelo;
            document.getElementById('version').value = auto.versión;
            document.getElementById('ano').value = auto.año;
            document.getElementById('motor').value = auto.motor || '';
            document.getElementById('transmision').value = auto.transmision || '';
            document.getElementById('combustible').value = auto.combustible || '';
            document.getElementById('gnc').value = auto.gnc || 'no';
            document.getElementById('color').value = auto.color || '';
            document.getElementById('kilometraje').value = auto.kilometraje;
            document.getElementById('precio').value = auto.precio;
            document.getElementById('moneda').value = auto.moneda;
            document.getElementById('descripcion').value = auto.descripcion || '';
            document.getElementById('categoria').value = auto.categoria || 'auto';
            document.getElementById('whatsapp').value = auto.whatsapp || '';
            document.getElementById('nuevo').checked = auto.nuevo || false;
            document.getElementById('destacado').checked = auto.destacado || false;
            document.getElementById('oferta').checked = auto.oferta || false;
            document.getElementById('recienLlegados').checked = auto.recienLlegados || false;
            
            caracteristicas = auto.caracteristicas || [];
            updateCaracteristicasList();
            
            selectedImages = auto.imagenes || [];
            updateImagePreview();
            
            document.getElementById('autoModal').classList.add('active');
        }

        // Guardar
        async function saveAuto(e) {
            e.preventDefault();
            
            const autoData = {
                id: currentAutoId || Math.floor(Math.random() * 10000),
                marca: document.getElementById('marca').value,
                modelo: document.getElementById('modelo').value,
                versión: document.getElementById('version').value,
                año: parseInt(document.getElementById('ano').value),
                motor: document.getElementById('motor').value,
                transmision: document.getElementById('transmision').value,
                combustible: document.getElementById('combustible').value,
                gnc: document.getElementById('gnc').value,
                color: document.getElementById('color').value,
                kilometraje: parseInt(document.getElementById('kilometraje').value),
                precio: parseFloat(document.getElementById('precio').value),
                moneda: document.getElementById('moneda').value,
                descripcion: document.getElementById('descripcion').value,
                categoria: document.getElementById('categoria').value,
                whatsapp: document.getElementById('whatsapp').value,
                nuevo: document.getElementById('nuevo').checked,
                destacado: document.getElementById('destacado').checked,
                oferta: document.getElementById('oferta').checked,
                recienLlegados: document.getElementById('recienLlegados').checked,
                caracteristicas: caracteristicas,
                imagenes: selectedImages,
                imagen: selectedImages[0] || ''
            };

            try {
                // Guardar en servidor
                const url = currentAutoId 
                    ? `/api/auto/${currentAutoId}` 
                    : '/api/auto';
                const method = currentAutoId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(autoData)
                });

                if (response.ok) {
                    // Actualizar array local
                    if (currentAutoId) {
                        const idx = autos.findIndex(a => a.id === currentAutoId);
                        autos[idx] = autoData;
                    } else {
                        autos.push(autoData);
                    }
                    
                    // Marcar como cambio para sincronizar
                    hasChanges = true;
                    
                    // Sincronizar con servidor inmediatamente
                    await sincronizarAutos();
                    
                    showToast(currentAutoId ? 'Auto actualizado ✓' : 'Auto creado ✓', 'success');
                    closeAutoModal();
                    loadAutos();
                    loadDashboard();
                } else {
                    showToast('Error al guardar el auto', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de conexión', 'error');
            }
        }

        // Eliminar
        async function deleteAuto(autoId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este auto?')) return;
            
            try {
                const response = await fetch(`/api/auto/${autoId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    autos = autos.filter(a => a.id !== autoId);
                    showToast('Auto eliminado ✓', 'success');
                    loadAutos();
                    loadDashboard();
                } else {
                    showToast('Error al eliminar el auto', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de conexión', 'error');
            }
        }

        // Características
        function addCaracteristica() {
            const input = document.getElementById('newCaracteristica');
            const value = input.value.trim();
            if (value) {
                caracteristicas.push(value);
                input.value = '';
                updateCaracteristicasList();
            }
        }

        function removeCaracteristica(index) {
            caracteristicas.splice(index, 1);
            updateCaracteristicasList();
        }

        function updateCaracteristicasList() {
            const list = document.getElementById('caracteristicas-list');
            list.innerHTML = caracteristicas.map((car, i) => `
                <div class="item">
                    <span>${car}</span>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeCaracteristica(${i})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Imágenes
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.style.borderColor = '#dc2626';
            e.currentTarget.style.background = '#fef2f2';
        }

        function handleDragLeave(e) {
            e.currentTarget.style.borderColor = '#d1d5db';
            e.currentTarget.style.background = '#f9fafb';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.style.borderColor = '#d1d5db';
            e.currentTarget.style.background = '#f9fafb';
            handleFiles(e.dataTransfer.files);
        }

        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }

        function handleFiles(files) {
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        selectedImages.push(e.target.result);
                        updateImagePreview();
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagePreview();
        }

        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = selectedImages.map((img, i) => `
                <div class="image-preview">
                    <img src="${img}" alt="preview">
                    <button type="button" class="remove-image" onclick="removeImage(${i})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Utilidades
        function formatCurrency(value) {
            return value.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Sincronizar todos los autos con el servidor
        async function sincronizarAutos() {
            if (autos.length === 0) {
                showToast('No hay autos para sincronizar', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/guardar-todos-autos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ autos: autos })
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(`✓ ${result.mensaje}`, 'success');
                    console.log('Autos guardados:', result);
                } else {
                    const error = await response.json();
                    showToast(`Error: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('Error sincronizando:', error);
                showToast('Error al sincronizar: ' + error.message, 'error');
            }
        }

        // Auto-guardar cada 15 segundos si hay cambios
        let lastSyncTime = 0;
        let hasChanges = false;
        
        setInterval(() => {
            if (hasChanges && autos.length > 0 && document.visibilityState === 'visible') {
                const now = Date.now();
                // Solo sincronizar si ha pasado más de 15 segundos desde la última sincronización
                if (now - lastSyncTime > 15000) {
                    sincronizarAutos();
                    lastSyncTime = now;
                    hasChanges = false;
                    console.log('Auto-guardado completado');
                }
            }
        }, 5000);

        document.addEventListener('click', (e) => {
            const modal = document.getElementById('autoModal');
            if (e.target === modal) closeAutoModal();
        });
    </script>
</body>
</html>
